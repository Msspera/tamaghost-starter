
services:
  web:
    build: 
      context: ./apps/web
      args:
        NEXT_PUBLIC_API_INTERACTIONS_URL: ${NEXT_PUBLIC_API_INTERACTIONS_URL}
        NEXT_PUBLIC_API_PET_URL: ${NEXT_PUBLIC_API_PET_URL}
        NEXT_PUBLIC_API_COMMENTS_URL: ${NEXT_PUBLIC_API_COMMENTS_URL}
        NEXT_PUBLIC_API_LEADERBOARD_URL: ${NEXT_PUBLIC_API_LEADERBOARD_URL}
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL}
        NEXT_PUBLIC_ASSET_BASE_URL: ${NEXT_PUBLIC_ASSET_BASE_URL}
    container_name: tamaghost-web
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_INTERACTIONS_URL: ${NEXT_PUBLIC_API_INTERACTIONS_URL}
      NEXT_PUBLIC_API_PET_URL: ${NEXT_PUBLIC_API_PET_URL}
      NEXT_PUBLIC_API_COMMENTS_URL: ${NEXT_PUBLIC_API_COMMENTS_URL}
      NEXT_PUBLIC_API_LEADERBOARD_URL: ${NEXT_PUBLIC_API_LEADERBOARD_URL}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL}
      NEXT_PUBLIC_ASSET_BASE_URL: ${NEXT_PUBLIC_ASSET_BASE_URL}
    depends_on:
      - interactions
      - pet-state
      - comments
      - leaderboard-api
      - chat

  interactions:
    build: ./services/interactions
    container_name: tamaghost-interactions
    ports:
      - "4001:4001"
    environment:
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_SASL_ENABLED: ${KAFKA_SASL_ENABLED}
      KAFKA_SASL_USERNAME: ${KAFKA_SASL_USERNAME}
      KAFKA_SASL_PASSWORD: ${KAFKA_SASL_PASSWORD}
      KAFKA_SSL_ENABLED: ${KAFKA_SSL_ENABLED}
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}
    depends_on:
      - redpanda

  pet-state:
    build: ./services/pet-state
    container_name: tamaghost-pet-state
    ports:
      - "4002:4002"
    environment:
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_SASL_ENABLED: ${KAFKA_SASL_ENABLED}
      KAFKA_SASL_USERNAME: ${KAFKA_SASL_USERNAME}
      KAFKA_SASL_PASSWORD: ${KAFKA_SASL_PASSWORD}
      KAFKA_SSL_ENABLED: ${KAFKA_SSL_ENABLED}
      DB_MODE: ${DB_MODE}
      SQLITE_FILE: ${SQLITE_FILE}
      AJD_SODA_BASE_URL: ${AJD_SODA_BASE_URL}
      AJD_SODA_AUTH_TOKEN: ${AJD_SODA_AUTH_TOKEN}
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}
    volumes:
      - sqlite:/data
    depends_on:
      - redpanda

  comments:
    build: ./services/comments
    container_name: tamaghost-comments
    ports:
      - "4003:4003"
    environment:
      DB_MODE: ${DB_MODE}
      SQLITE_FILE: ${SQLITE_FILE}
      AJD_SODA_BASE_URL: ${AJD_SODA_BASE_URL}
      AJD_SODA_AUTH_TOKEN: ${AJD_SODA_AUTH_TOKEN}
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}
    volumes:
      - sqlite:/data

  leaderboard-worker:
    build: ./services/leaderboard-worker
    container_name: tamaghost-leaderboard-worker
    environment:
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_SASL_ENABLED: ${KAFKA_SASL_ENABLED}
      KAFKA_SASL_USERNAME: ${KAFKA_SASL_USERNAME}
      KAFKA_SASL_PASSWORD: ${KAFKA_SASL_PASSWORD}
      KAFKA_SSL_ENABLED: ${KAFKA_SSL_ENABLED}
      REDIS_URL: ${REDIS_URL}
    depends_on:
      - redpanda
      - redis

  leaderboard-api:
    build: ./services/leaderboard-api
    container_name: tamaghost-leaderboard-api
    ports:
      - "4005:4005"
    environment:
      REDIS_URL: ${REDIS_URL}
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}
    depends_on:
      - redis

  chat:
    build: ./services/chat
    container_name: tamaghost-chat
    ports:
      - "7001:7001"
    environment:
      REDIS_URL: ${REDIS_URL}

  # Infra (local)
  redpanda:
    image: redpandadata/redpanda:v23.3.12
    container_name: redpanda
    command: >
      redpanda start --overprovisioned --smp 1 --memory 512M --reserve-memory 0M
      --node-id 0 --check=false --set redpanda.auto_create_topics_enabled=true
      --kafka-addr PLAINTEXT://0.0.0.0:9092,OUTSIDE://0.0.0.0:19092
      --advertise-kafka-addr PLAINTEXT://redpanda:9092,OUTSIDE://localhost:9092
    ports:
      - "9092:19092"
    healthcheck:
      test: ["CMD", "bash", "-c", "rpk cluster info -X brokers=localhost:19092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  console:
    image: redpandadata/console:v2.6.0
    container_name: redpanda-console
    ports:
      - "8081:8080"
    environment:
      - KAFKA_BROKERS=redpanda:9092
    depends_on:
      - redpanda

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"

volumes:
  sqlite: {}
