FROM node:20-alpine
WORKDIR /app
COPY package.json package-lock.json* ./
RUN npm install --legacy-peer-deps || npm i
COPY . .

# 1. Declara que aceitamos estes argumentos do Docker Compose
ARG NEXT_PUBLIC_API_INTERACTIONS_URL
ARG NEXT_PUBLIC_API_PET_URL
ARG NEXT_PUBLIC_API_COMMENTS_URL
ARG NEXT_PUBLIC_API_LEADERBOARD_URL
ARG NEXT_PUBLIC_WS_URL
ARG NEXT_PUBLIC_ASSET_BASE_URL

# 2. (CRUCIAL) Transforma os argumentos em Variáveis de Ambiente persistentes para o build
ENV NEXT_PUBLIC_API_INTERACTIONS_URL=$NEXT_PUBLIC_API_INTERACTIONS_URL
ENV NEXT_PUBLIC_API_PET_URL=$NEXT_PUBLIC_API_PET_URL
ENV NEXT_PUBLIC_API_COMMENTS_URL=$NEXT_PUBLIC_API_COMMENTS_URL
ENV NEXT_PUBLIC_API_LEADERBOARD_URL=$NEXT_PUBLIC_API_LEADERBOARD_URL
ENV NEXT_PUBLIC_WS_URL=$NEXT_PUBLIC_WS_URL
ENV NEXT_PUBLIC_ASSET_BASE_URL=$NEXT_PUBLIC_ASSET_BASE_URL

# 3. Agora o build conseguirá "ver" as variáveis
RUN npm run build

EXPOSE 3000
CMD ["npm", "run", "start"]